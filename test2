elif stage_from_node == "NPI_ASK_MODE":
    ptitle = interrupt_payload.get("prompt_title") or last_state.get("prompt_title") or "Would you like to search by Zip Code or Name?"
    pr = interrupt_payload.get("prompts") or last_state.get("prompts") or ["Zip Code", "Name"]

    response_payload = base_response(
        thread_id=req.thread_id,
        stage="NPI_ASK_MODE",
        ai_response="",
        csr_query=req.message or "",
        prompts=pr,
        prompt_title=ptitle,
        ai_response_code=101,
        ai_response_type="AURA",
        call_source=call_source,
    )
    break

===========================

elif stage_from_node == "NPI_ASK_QUERY":
    ai_resp_text = prompt or last_state.get("ai_response", "")

    response_payload = base_response(
        thread_id=req.thread_id,
        stage="NPI_ASK_QUERY",
        ai_response=ai_resp_text,
        csr_query=req.message or "",
        prompts=[],
        prompt_title="",
        ai_response_code=103,
        ai_response_type="Dialog",
        call_source=call_source,
    )
    break
===================================
elif stage_from_node == "NPI_RESULTS":
    ai_resp_text = prompt or last_state.get("ai_response", "")

    response_payload = base_response(
        thread_id=req.thread_id,
        stage="NPI_RESULTS",
        ai_response=ai_resp_text,
        csr_query=req.message or "",
        prompts=[],
        prompt_title="",
        ai_response_code=110,
        ai_response_type="AURA",
        call_source=call_source,
    )
    break
====================    

def node_npi_ask_mode(state: PCPState) -> PCPState:
    """
    Ask user whether they want to search NPI by Zip Code or Name.
    Deterministic routing: no LLM.
    """
    # If already chosen (resume safety), skip asking again
    if state.get("npi_mode") in ("zip", "name"):
        return state

    state["ai_response"] = ""
    state["ai_response_type"] = "AURA"
    state["ai_response_code"] = 101
    state["prompt_title"] = "Search Provider NPI (Web): search by Zip Code or Name?"
    state["prompts"] = ["Zip Code", "Name"]
    state["stage"] = "NPI_ASK_MODE"

    requested = interrupt({
        "prompt": "",
        "stage": state["stage"],
        "prompt_title": state["prompt_title"],
        "prompts": state["prompts"],
    })

    # âœ… FIX #3: deterministic mapping
    choice = str(requested).strip().lower()
    if "zip" in choice:
        state["npi_mode"] = "zip"
    elif "name" in choice:
        state["npi_mode"] = "name"
    else:
        state["npi_mode"] = None  # fallback

    # clear csr_query so next node doesn't misread it
    state["csr_query"] = ""
    return state

==========================================

def node_npi_ask_query(state: PCPState) -> PCPState:
    """
    Ask for zip or name input depending on npi_mode.
    """
    if state.get("npi_query"):
        return state

    mode = state.get("npi_mode")
    if mode == "zip":
        question = "Please enter the Zip Code to search the NPI registry (e.g., 10001 or 10001-1234)."
    elif mode == "name":
        question = "Please enter the Provider Name to search the NPI registry (e.g., 'john' or 'Amy Pandya')."
    else:
        # If somehow mode is missing, re-ask mode
        state["stage"] = "NPI_ASK_MODE"
        return state

    state["ai_response"] = question
    state["ai_response_type"] = "Dialog"
    state["ai_response_code"] = 103
    state["prompt_title"] = ""
    state["prompts"] = []
    state["stage"] = "NPI_ASK_QUERY"

    requested = interrupt({
        "prompt": question,
        "stage": state["stage"],
    })

    state["npi_query"] = str(requested).strip()
    state["csr_query"] = ""
    return state

============================
