def node_assign_pcp_ask_termination(state: PCPState) -> PCPState:
    logger = logging.getLogger("pcp.assign_pcp")
    logger.debug("node_assign_pcp_ask_termination, state=%s", state)

    # ✅ IMPORTANT: If we entered Assign-PCP from a menu selection,
    # wipe transient PCP keys so we NEVER treat "Assign PCP" as termination_reason.
    st = (state.get("stage") or "").strip().upper()
    if st in ("START", "MENU", "GO_MENU"):
        for k in (
            "termination_reason",
            "knows_provider",
            "raw_provider_input",
            "raw_filter_input",
            "providers_result",
            "provider_id",
            "provider_name",
            "provider_city",
            "provider_state",
            "startingLocationZip",
            "asOfDate",
            "last_followup_action",
            "initial_assign_text",
            "last_selected_provider_id",
            "selected_provider_snapshot",
            "provider_id_override",
        ):
            state.pop(k, None)

        # also make sure we do not carry the menu selection forward as a "reason"
        state["csr_query"] = ""
==============================
def node_collect_termination_reason(state: PCPState) -> PCPState:
    logger.debug("node_collect_termination_reason")

    if state.get("termination_reason"):
        return state

    reason = (state.get("csr_query") or "").strip()
    if not reason:
        return state

    # ✅ Safety: do not treat menu choice as termination reason
    menu_prompts = getattr(settings, "MENU_PROMPTS", None)
    if not isinstance(menu_prompts, list) or not menu_prompts:
        menu_prompts = settings.DEFAULT_PROMPTS

    if reason in menu_prompts:
        state["csr_query"] = ""
        return state

    state["termination_reason"] = reason
    state["csr_query"] = ""
    return state
