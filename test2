def llm_classify_yes_no(user_text: str) -> str:
    """
    Returns: "yes" | "no" | "unknown"
    Uses Horizon to avoid hardcoded string matching.
    """
    system = (
        "You classify whether the user's response means YES or NO.\n"
        "Return ONLY JSON: {\"answer\":\"yes\"|\"no\"|\"unknown\"}\n"
        "Consider spelling mistakes, short answers, and semantic variants.\n"
    )
    raw = call_horizon(system, user_text or "").strip()

    if raw.startswith("```"):
        raw = raw.strip("`")
        idx = raw.find("{")
        if idx != -1:
            raw = raw[idx:]

    try:
        data = json.loads(raw)
        ans = str(data.get("answer") or "unknown").strip().lower()
        if ans in ("yes", "no", "unknown"):
            return ans
        return "unknown"
    except Exception:
        logger.warning("Failed to parse yes/no JSON from LLM: %s", raw)
        return "unknown"

=============================================================================

def route_after_provider_search_results(state: PCPState) -> str:
    """
    After run_provider_search:
      - if providers exist -> "found"
      - if none -> "no_results"
    """
    providers = state.get("providers_result") or []
    if isinstance(providers, list) and len(providers) > 0:
        return "found"
    return "no_results"


def route_after_no_results_offer(state: PCPState) -> str:
    """
    After we ask: "Do you want NPI web search?"
    Use Horizon to classify yes/no (no hardcoded match).
    """
    txt = (state.get("csr_query") or "").strip()
    ans = llm_classify_yes_no(txt)
    if ans == "yes":
        return "npi"
    if ans == "no":
        return "menu"
    # unknown -> re-ask offer (safe)
    return "loop"


============================================================

def node_pcp_no_results_route(state: PCPState) -> PCPState:
    """
    This node runs AFTER we asked user:
      'No record found... do you want NPI web search?'

    It doesn't interrupt. It just prepares state so the graph routes
    to either NPI flow or menu via conditional edges.
    """
    logger.debug("node_pcp_no_results_route")

    # Defensive cleanup so we don't keep reusing stale provider results
    state["providers_result"] = None
    state["raw_provider_input"] = None
    state["raw_filter_input"] = None

    # Keep csr_query as user's yes/no answer for routing function
    return state


==============================================================================

if not providers:
    # Ask via Horizon LLM (no hardcode message content)
    search_basis = (state.get("raw_provider_input") or state.get("raw_filter_input") or "").strip()
    if not search_basis:
        search_basis = state.get("csr_query") or ""

    sys = (
        "You are a CSR assistant.\n"
        "The internal provider directory search returned no results.\n"
        "Ask the user if they would like to try the NPI Web search instead.\n"
        "Return ONLY the question text (no JSON, no markdown fences).\n"
        "The question must mention that no record was found for the provided input.\n"
    )
    user = f"No provider record found for: {search_basis}"
    ai_msg = call_horizon(sys, user).strip()
    mark_llm(state)

    state["ai_response"] = ""
    state["ai_response_type"] = "AURA"
    state["ai_response_code"] = 101
    state["prompt_title"] = ai_msg
    state["prompts"] = ["Yes", "No"]
    state["stage"] = "PCP_NO_RESULTS_OFFER_NPI"

    requested = interrupt({
        "prompt": "",  # UI uses PromptTitle + Prompts here
        "stage": state["stage"],
        "prompt_title": state["prompt_title"],
        "prompts": state["prompts"],
        "ai_response_code": state["ai_response_code"],
        "ai_response_type": state["ai_response_type"],
    })

    # store user's answer (yes/no) for the next routing node
    state["csr_query"] = str(requested).strip()
    return state


===============================================================

builder.add_node("pcp_no_results_route", node_pcp_no_results_route)

builder.add_conditional_edges(
    "run_provider_search",
    path=route_after_provider_search_results,
    path_map={
        "found": "provider_interaction",
        "no_results": "pcp_no_results_route",
    },
)


builder.add_conditional_edges(
    "pcp_no_results_route",
    path=route_after_no_results_offer,
    path_map={
        "npi": "npi_ask_mode",
        "menu": "return_to_menu",
        "loop": "run_provider_search",  # safest: re-run offer node again via no-results path
    },
)

=================================================================================================

elif stage_from_node == "PCP_NO_RESULTS_OFFER_NPI":
    ptitle = interrupt_payload.get("prompt_title") or last_state.get("prompt_title") or ""
    pr = interrupt_payload.get("prompts") or last_state.get("prompts") or ["Yes", "No"]

    response_payload = base_response(
        thread_id=req.thread_id,
        stage="PCP_NO_RESULTS_OFFER_NPI",
        ai_response="",
        csr_query=req.message or "",
        prompts=pr,
        prompt_title=ptitle,
        ai_response_code=101,
        ai_response_type="AURA",
        call_source=call_source,
    )
    break

