def node_npi_run_search(state: PCPState) -> PCPState:
    """
    NPI Web flow:
      - Reads state["npi_mode"] = "zip" | "name"
      - Reads state["npi_query"] (zip or name text)
      - Calls NPI registry service (API)
      - Returns JSON results in state["ai_response"]
      - Interrupts with stage "NPI_SHOW_RESULTS" so /chat can return AIResponse JSON
    """

    logger.debug("node_npi_run_search")

    # If already have results, don't re-run (resume safety)
    if state.get("npi_results_payload"):
        state["ai_response"] = json.dumps(state["npi_results_payload"], default=str, separators=(",", ":"))
        state["ai_response_type"] = "AURA"
        state["ai_response_code"] = 107
        state["prompt_title"] = getattr(settings, "NPI_RESULTS_PROMPT_TITLE", "")
        state["prompts"] = getattr(settings, "NPI_RESULTS_PROMPTS", [])
        state["stage"] = "NPI_SHOW_RESULTS"

        requested = interrupt({
            "prompt": state["ai_response"],
            "stage": state["stage"],
            "prompt_title": state["prompt_title"],
            "prompts": state["prompts"],
        })
        state["csr_query"] = str(requested).strip()
        return state

    mode = (state.get("npi_mode") or "").strip().lower()
    query = (state.get("npi_query") or "").strip()

    # Safety: if missing inputs, donâ€™t break flow; just ask again via interrupt
    if mode not in ("zip", "name"):
        # Let existing node_npi_ask_mode handle, but avoid breaking:
        state["ai_response"] = ""
        state["ai_response_type"] = "AURA"
        state["ai_response_code"] = 101
        state["prompt_title"] = getattr(settings, "NPI_MODE_PROMPT_TITLE", "Choose search type")
        state["prompts"] = getattr(settings, "NPI_MODE_PROMPTS", ["Zip Code", "Name"])
        state["stage"] = "NPI_ASK_MODE"

        requested = interrupt({
            "prompt": "",
            "stage": state["stage"],
            "prompt_title": state["prompt_title"],
            "prompts": state["prompts"],
        })
        state["csr_query"] = str(requested).strip()
        return state

    if not query:
        # Let existing node_npi_ask_query handle, but avoid breaking:
        state["ai_response"] = ""
        state["ai_response_type"] = "AURA"
        state["ai_response_code"] = 101
        state["prompt_title"] = getattr(settings, "NPI_QUERY_PROMPT_TITLE", "Enter search value")
        state["prompts"] = getattr(settings, "NPI_QUERY_PROMPTS", [])
        state["stage"] = "NPI_ASK_QUERY"

        requested = interrupt({
            "prompt": "",
            "stage": state["stage"],
            "prompt_title": state["prompt_title"],
            "prompts": state["prompts"],
        })
        state["csr_query"] = str(requested).strip()
        return state

    # ------------------ Perform API search ------------------
    results: List[Dict[str, Any]] = []
    try:
        if mode == "zip":
            mark_api(state, npi_search_by_zip)
            results = npi_search_by_zip(query)
        else:
            mark_api(state, npi_search_by_name)
            results = npi_search_by_name(query)

    except Exception as ex:
        logger.exception("NPI search failed: %s", ex)
        # Keep flow alive but return an error response (no hardcoded text if you have a setting)
        err_msg = getattr(settings, "NPI_ERROR_MESSAGE", "Unable to fetch NPI results right now. Please try again.")
        state["ai_response"] = err_msg
        state["ai_response_type"] = "AURA"
        state["ai_response_code"] = 500
        state["prompt_title"] = ""
        state["prompts"] = []
        state["stage"] = "ERROR"
        return state

    # ------------------ Build JSON payload ------------------
    # Keep the payload shape consistent for your UI
    payload: Dict[str, Any] = {
        "npiSearch": {
            "mode": mode,
            "query": query,
            "count": len(results),
            "providers": results,
        }
    }

    state["npi_results_payload"] = payload

    # Contract: AIResponse holds JSON
    state["ai_response"] = json.dumps(payload, default=str, separators=(",", ":"))
    state["ai_response_type"] = "AURA"
    state["ai_response_code"] = 107
    state["prompt_title"] = getattr(settings, "NPI_RESULTS_PROMPT_TITLE", "")
    state["prompts"] = getattr(settings, "NPI_RESULTS_PROMPTS", [])
    state["stage"] = "NPI_SHOW_RESULTS"

    # Interrupt so /chat returns the results immediately
    requested = interrupt({
        "prompt": state["ai_response"],
        "stage": state["stage"],
        "prompt_title": state["prompt_title"],
        "prompts": state["prompts"],
        "ai_response_code": state["ai_response_code"],
        "ai_response_type": state["ai_response_type"],
    })

    # Store next user message (graph edges can route to menu afterward)
    state["csr_query"] = str(requested).strip()
    return state
